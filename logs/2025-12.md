# 2025-12 作業ログ

## 2025-12-13 speak-itプロジェクト立ち上げ

### 概要
テキスト読み上げWebアプリ「speak-it」を新規作成。

### 作業内容

#### 1. プロジェクト初期化
- Vite + Vanilla JS でセットアップ
- 基本UI実装（テキストエリア、音声選択、速度/音量調整、再生ボタン）

#### 2. Web Speech API でMVP
- ブラウザ内蔵の音声合成で動作確認
- 問題なく動作するが、音声品質に限界あり

#### 3. Google Cloud TTS 統合
- APIキー取得、REST API経由で音声生成
- **重大な問題発生**: MP3形式で約70文字付近で音声が途切れる

#### 4. 問題解決の試行錯誤
| 試したこと | 結果 |
|-----------|------|
| チャンク分割（200文字→100文字） | 効果なし |
| OGG_OPUS形式 | 効果なし |
| Blob URL | 効果なし |
| DOM audio要素 | 効果なし |
| canplaythrough待ち | 効果なし |

#### 5. 解決策: LINEAR16 + AudioContext
- **MP3ではなくLINEAR16（生PCM）形式**を使用
- AudioContext APIで直接再生
- base64 → Int16Array → Float32Array → AudioBuffer の変換処理

#### 6. チャンク間のブツ切れ問題
- チャンク分割をやめ、**1回のAPIコールで全文送信**
- 300文字程度なら5000バイト制限に収まる

#### 7. 開始時クリックノイズ
- GainNodeで**20msフェードイン**を適用
- `linearRampToValueAtTime`で滑らかに音量を上げる

### 技術的教訓
1. **Google Cloud TTS + ブラウザでMP3は要注意**: デコーダーの問題で途中から再生が途切れることがある
2. **LINEAR16が安定**: 生PCMデータは変換が必要だが確実に動作
3. **AudioContext APIを使う**: Audio要素より低レベルで制御でき、安定している
4. **クリックノイズ対策にはフェードイン**: 急激な音量変化を避ける

#### 8. 長文対応（バッファ連結方式）
- **問題**: Google Cloud TTS API は5000バイト/リクエストの制限
- **以前の失敗**: チャンクを順次再生 → チャンク間で「ブツッ」ノイズ
- **解決策**: バッファ連結方式
  1. 長文を4500バイト以下のチャンクに分割（段落→文末→読点の優先順位）
  2. 全チャンク並列でAPI呼び出し（高速化）
  3. Float32Arrayとして連結
  4. 単一AudioBufferとして再生
- **結果**: チャンク境界でノイズなし、シームレス再生成功
- **テスト**: 7160バイト → 2チャンク分割 → 458秒の音声をノイズなし再生

### 技術的教訓
1. **Google Cloud TTS + ブラウザでMP3は要注意**: デコーダーの問題で途中から再生が途切れることがある
2. **LINEAR16が安定**: 生PCMデータは変換が必要だが確実に動作
3. **AudioContext APIを使う**: Audio要素より低レベルで制御でき、安定している
4. **クリックノイズ対策にはフェードイン**: 急激な音量変化を避ける
5. **長文はバッファ連結**: 順次再生ではなく、連結してから再生でノイズ回避

#### 9. バグ修正・機能追加
- **冒頭ノイズ再発** → GainNodeフェードインからデータレベルフェードイン（50ms）に変更
- **一時停止機能** → `AudioContext.suspend()/resume()`で実装
- **リアルタイム音量調整** → GainNode経由で再生中も変更可能に
- **速度変更** → 再生中の変更は音程が変わるため、次の再生から反映する仕様に

### 残課題
- 音声ダウンロード機能
- APIキーのセキュリティ対策

## 2025-12-14 Renderデプロイ

### 概要
speak-itをRenderにデプロイ。フロントエンド（Static Site）+ バックエンド（Web Service）の構成。

### 作業内容

#### 1. render.yaml作成・修正
- Blueprint方式でのデプロイ設定
- **問題1**: `fromService.property: url` が無効 → 手動環境変数設定方式に変更
- **問題2**: Static Siteに `plan: free` は指定不可 → 削除

#### 2. バックエンドAPIプロキシ
- `server/index.js`: Express + CORS設定
- Google TTS APIキーをサーバー側で管理（セキュリティ対策）
- エンドポイント: `/api/voices`, `/api/synthesize`, `/health`

#### 3. 環境変数問題
- **問題**: Viteの `import.meta.env.VITE_API_URL` がビルド時に反映されない
- **原因**: Render Static Siteでのビルド時環境変数の扱い
- **解決**: ホスト名による自動判定フォールバックを実装
  ```javascript
  const API_BASE_URL = import.meta.env.VITE_API_URL ||
    (window.location.hostname === 'localhost' ? 'http://localhost:3001' : 'https://speak-it-api.onrender.com');
  ```

#### 4. デプロイ完了
- フロントエンド: https://speak-it.onrender.com
- バックエンド: https://speak-it-api.onrender.com
- 動作確認OK

### 技術的教訓
1. **Render Blueprint**: `fromService.property` で `url` は使えない（`host`, `port` 等のみ）
2. **Vite環境変数**: Static Siteではビルド時に反映されない場合あり、フォールバック実装推奨
3. **無料プラン注意**: 15分無操作でスピンダウン、再起動に50秒程度かかる
